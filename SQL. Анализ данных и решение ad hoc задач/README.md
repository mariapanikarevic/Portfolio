# SQL. Анализ данных и решение ad hoc задач.
## Описание проекта
«Секреты Темнолесья» — это онлайн-игра, в которой каждый игрок следует по сюжету своего персонажа, выполняет задания и исследует огромный виртуальный мир.

В начале игры пользователь выбирает расу героя. От расы зависит отношение к пользователю торговцев и других игроков, а также неигровых персонажей — тех, которые не контролируются игроками. У каждой расы свои плюсы и минусы, и вот несколько примеров:
- Эльфы приняты в светских кругах, и высшие сословия всегда помогут им при прохождении задания. Правда, торговцы и простые горожане будут относиться к эльфам с недоверием и страхом из-за высокого происхождения этих существ.
- К оркам в высшем обществе отнесутся с презрением, а простые люди будут их бояться. Однако орков уважают воины, и посетители таверн будут готовы рассказать им необходимую информацию.
  
Кроме того, игрок выбирает класс персонажа, у которого тоже есть свои особенности. Например, маг искусен в дальних атаках, но чрезвычайно слаб здоровьем. Рыцарь силён и обладает огромным запасом здоровья, но при этом не умеет работать с магическими предметами и заклинаниями, что делает его к ним уязвимым.
 
Игрок также выбирает легендарную способность, которую нельзя изменить в процессе игры. Такая способность помогает при прохождении, наделяя персонажа дополнительными умениями: например, устойчивостью ко льду или силой исцеления.

В игре можно покупать и продавать разные вещи: оружие, доспехи, еду, магические предметы и амулеты. Для покупок используют внутриигровую валюту. Такой валюты в игре две:
- Обычные монеты, которые можно заработать при прохождении игры. Они позволяют покупать обычные предметы.
- Валюта «райские лепестки», за которую можно покупать эпические предметы. Такие предметы дают преимущество при прохождении игры. «Райские лепестки» можно получить за прохождение сложных квестов или купить за реальные деньги. Покупать эпические предметы можно у других игроков, торговцев и внутри игрового приложения.
  
Разработчики утверждают, что игру можно пройти полностью без использования валюты «райские лепестки» и это опциональный способ ускорить прохождение. Однако для компании разработчика важно привлекать платящих игроков — тех, кто готов покупать внутриигровую валюту за реальные деньги.

**Задачи:**
- выяснить, какая доля игроков покупает внутриигровую валюту «райские лепестки» за реальные деньги и есть ли зависимость доли платящих игроков от расы персонажа;
- детально изучить, как происходит покупка эпических предметов внутри игры.

**Навыки и инстурменты:**

<img src="https://img.shields.io/badge/PostgreSQL-black?style=flat-square&logo=postgresql&logoColor=purple"/>

**Задача №1. Информация о таблицах**

Выведите названия всех таблиц схемы fantasy.

**Задача №2. Данные в таблице users**

Схема fantasy содержит семь таблиц.  Стоит предположить, что к ключевым таблицам можно отнести users с информацией об игроках и events с информацией о внутриигровых покупках с использованием игровой валюты «райские лепестки». Остальные таблицы содержат более детальную информацию об игроках и эпических предметах. 
Получите информацию о названии полей таблицы users и типе данных в них, а также присоедините информацию о первичных и внешних ключах. Итоговая таблица должна содержать такие поля: 
- table_schema — название схемы;
- table_name — название таблицы;
- column_name — название поля;
- data_type — тип данных, которые хранятся в поле;
- constraint_name — информация о первичном или внешнем ключе. Поле может содержать значения NULL — это значит, что поле не имеет ограничений и не используется в качестве первичного или внешнего ключа.

**Задача №3. Вывод первых строк таблицы users**

Теперь познакомьтесь с данными — выведите первые пять строк таблицы users. При этом в выдачу добавьте поле row_count с подсчётом общего количества строк в таблице. Так можно не только проконтролировать содержимое данных, но и оценить их общее количество.

**Задача №4. Проверка пропусков в таблице users**

В данных присутствует первичный ключ — идентификатор игрока, поэтому проблему с полными дубликатами строк можно исключить. Проверьте другой тип ошибки — пропуски.
Напишите запрос, который посчитает общее количество строк с пропусками в любом из полей, которые понадобятся при анализе: class_id, ch_id, pers_gender, server, race_id, payer, loc_id.

**Задача №5. Знакомство с категориальными данными таблицы users**

Таблица users содержит информацию об игроках. В данных можно выделить такие категории: характеристика персонажа, его пол, класс, легендарный навык, а также страна регистрации игрока или игровой сервер.
В этом задании выведите уникальные значения в поле server таблицы users и для каждого сервера найдите количество строк.

**Задача №6. Знакомство с таблицей events**

Вторая таблица, с которой вам нужно поработать, — это таблица с информацией о внутриигровых покупках events. Изучите её более внимательно, как это делали с таблицей users.
Выведите названия всех полей, их тип данных и информацию о ключевых полях таблицы events. При решении задачи используйте написанный код.

**Задача №7. Выведите первые пять строк таблицы events**

В предыдущей задаче вы получили информацию о полях таблицы events. Обратите внимание на тип данных у полей с датой date и временем time — там хранятся значения типа character varying, а это не совсем корректно. Эту особенность нужно учитывать при работе с датой и временем.
Теперь к заданию — выведите первые пять строк таблицы events. При этом в выдачу добавьте поле row_count с подсчётом общего количества строк в таблице, как делали при изучении таблицы users.

**Задача №8. Проверка пропусков в таблице events**

Проверьте данные в таблице events на возможные ошибки и начните с пропусков. Напишите запрос и найдите количество строк с пропусками в полях, которые будут использоваться при анализе: date, time, amount, seller_id.

**Задача №9. Изучаем пропуски в таблице events**

Теперь детально изучите строки с пропусками в каждом из полей — это поможет узнать количество пропущенных значений в каждом столбце. 
Дополните код предыдущего задания и выведите количество данных в каждом из полей date, time, amount, seller_id. Итоговая таблица должна содержать такие поля:
data_count — количество строк с данными в поле date;
data_time — количество строк с данными в поле time;
data_amount — количество строк с данными в поле amount;
data_seller_id — количество строк с данными в поле seller_id.

**Задача №10. Исследование доли платящих игроков**

Изучите, какую долю составляют игроки, которые купили внутриигровую валюту «райские лепестки» за реальные деньги, от общего количества зарегистрированных игроков. После этого проанализируйте, существует ли взаимосвязь доли платящих игроков от выбранной расы персонажа.
Напишите два SQL-запроса:
- Рассчитайте долю платящих игроков по всем данным и выгрузите несколько полей:
a. общее количество игроков, зарегистрированных в игре;
b. количество платящих игроков;
c. доля платящих игроков от общего количества пользователей, зарегистрированных в игре.
- Изучите, зависит ли доля платящих игроков от выбранной расы персонажа. Выведите следующие значения для каждой расы персонажа:
a. раса персонажа;
b. количество платящих игроков этой расы;
c. общее количество зарегистрированных игроков этой расы;
d. доля платящих игроков среди всех зарегистрированных игроков этой расы.

**Задача №11. Исследование внутриигровых покупок**

Изучите внутриигровую активность игроков по покупке эпических предметов за счёт игровой валюты «райские лепестки» и напишите несколько запросов:
1) Получите основные статистические показатели по полю покупки amount, включая:
   - общее количество покупок;
   - суммарную стоимость всех покупок;
   - минимальную и максимальную стоимость покупки;
   - среднее значение, медиану и стандартное отклонение стоимости покупки.
2) Проверьте, встречаются ли покупки с нулевой стоимостью. Если да, найдите их абсолютное количество и долю от общего числа покупок. Покупки с нулевой стоимостью не помогают зарабатывать внутриигровую валюту «райские лепестки», и их следует исключить при решении следующих задач.
3) Изучите популярность эпических предметов. Для каждого предмета посчитайте:
   - Общее количество внутриигровых продаж в абсолютном и относительном значениях. Относительное значение должно быть долей продажи каждого предмета от всех продаж.
   - Долю игроков, которые хотя бы раз покупали этот предмет, от общего числа внутриигровых покупателей.
     
Результат отсортируйте по популярности эпического предмета среди игроков. Убедитесь, что при написании запроса была проведена фильтрация покупок с нулевой стоимостью.

**Задача №12. Зависимость активности игроков от расы персонажа**

Коллеги из аналитического отдела хотят изучить активность игроков при покупке эпических предметов в разрезе разных рас персонажей. У коллег есть гипотеза, что игра за некоторые расы сложнее и требует большего количества покупок эпических предметов, которые помогают в прохождении. Коллеги стремятся убрать различия в прохождении игры между расами так, чтобы не было рас с лёгким прохождением и, наоборот, — с трудным. 

Чтобы ответить на вопрос коллег, посчитайте такие показатели для каждой игровой расы:
- общее количество зарегистрированных игроков;
- количество игроков, которые совершают внутриигровые покупки, и их доля от общего количества зарегистрированных игроков;
- доля платящих игроков среди игроков, которые совершили внутриигровые покупки;
- среднее количество покупок на одного игрока, совершившего внутриигровые покупки;
- средняя стоимость одной покупки на одного игрока, совершившего внутриигровые покупки;
- средняя суммарная стоимость всех покупок на одного игрока, совершившего внутриигровые покупки.
